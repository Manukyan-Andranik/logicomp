{% extends "base.html" %}
{% block title %}<span data-translate-key="page_register">Register</span>{% endblock %}

{% block extra_css %}
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<link href="{{ url_for('static', filename='css/auth-forms.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="auth-main">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-7 col-lg-5 col-xl-4" data-aos="fade-up">
                <div class="card auth-card">
                    <div class="card-body p-4 p-md-5">
                        <div class="text-center mb-5">
                            <i class="bi bi-person-plus-fill auth-icon"></i>
                            <h2 class="card-title" data-translate-key="register_title">Create an Account</h2>
                            {% if contest %}
                                <p class="contest-title">
                                    <span data-translate-key="register_for_contest">for contest</span> "{{ contest.title }}"
                                </p>
                            {% endif %}
                        </div>
                        
                        <!-- Progress Indicator -->
                        <div class="form-progress">
                            <div class="progress-line">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="progress-step active" data-step="1">1</div>
                            <div class="progress-step" data-step="2">2</div>
                            <div class="progress-step" data-step="3">3</div>
                        </div>
                        
                        <form method="POST" id="registerForm">
                            {{ form.hidden_tag() }}
                            
                            <div class="form-group" data-step="1">
                                {{ form.username.label(class="form-label", **{'data-translate-key': 'username_label'}) }}
                                <div class="position-relative">
                                    {{ form.username(class="form-control form-control-modern", placeholder="e.g. johndoe", **{'data-translate-key': 'username_placeholder'}) }}
                                    <i class="bi bi-person-fill input-icon"></i>
                                </div>
                                {% for error in form.username.errors %}
                                    <div class="invalid-feedback-custom">
                                        <i class="bi bi-exclamation-triangle-fill"></i>
                                        {{ error }}
                                    </div>
                                {% endfor %}
                            </div>
                            
                            <div class="form-group" data-step="2">
                                {{ form.email.label(class="form-label", **{'data-translate-key': 'email_label'}) }}
                                <div class="position-relative">
                                    {{ form.email(class="form-control form-control-modern", placeholder="e.g. john.doe@example.com", **{'data-translate-key': 'email_placeholder'}) }}
                                    <i class="bi bi-envelope-fill input-icon"></i>
                                </div>
                                {% for error in form.email.errors %}
                                    <div class="invalid-feedback-custom">
                                        <i class="bi bi-exclamation-triangle-fill"></i>
                                        {{ error }}
                                    </div>
                                {% endfor %}
                            </div>
                            
                            <div class="form-group" data-step="3">
                                <div class="d-grid mt-4">
                                    {{ form.submit(class="btn btn-auth", id="registerBtn") }}
                                </div>
                            </div>
                            
                            <hr class="divider">
                            
                            <div class="extra-links">
                                <span data-translate-key="have_account">Already have an account?</span>
                                <a href="{{ url_for('auth.login') }}" data-translate-key="sign_in">Sign In</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    AOS.init({ duration: 800, offset: 50, once: true });
    
    // Form validation and enhancement
    const form = document.getElementById('registerForm');
    const inputs = form.querySelectorAll('.form-control-modern');
    const submitBtn = document.getElementById('registerBtn');
    const progressSteps = document.querySelectorAll('.progress-step');
    const progressFill = document.getElementById('progressFill');
    
    // Real-time validation and progress tracking
    inputs.forEach((input, index) => {
        input.addEventListener('input', function() {
            validateField(this);
            updateProgress();
        });
        
        input.addEventListener('blur', function() {
            validateField(this);
            updateProgress();
        });
        
        input.addEventListener('focus', function() {
            this.parentElement.classList.add('focused');
            updateProgress();
        });
        
        // Add step attribute for progress tracking
        input.closest('.form-group').setAttribute('data-step', index + 1);
    });
    
    // Form submission
    form.addEventListener('submit', function(e) {
        if (!validateForm()) {
            e.preventDefault();
            return;
        }
        
        // Show loading state
        submitBtn.classList.add('loading');
        submitBtn.value = 'Creating Account...';
    });
    
    function validateField(field) {
        const value = field.value.trim();
        const fieldName = field.name;
        
        // Remove existing validation classes
        field.classList.remove('is-valid', 'is-invalid');
        
        if (value === '') {
            field.classList.add('is-invalid');
            return false;
        }
        
        // Specific validation rules
        if (fieldName === 'username') {
            if (value.length < 3) {
                field.classList.add('is-invalid');
                return false;
            }
            if (!/^[a-zA-Z0-9_]+$/.test(value)) {
                field.classList.add('is-invalid');
                return false;
            }
        }
        
        if (fieldName === 'email') {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(value)) {
                field.classList.add('is-invalid');
                return false;
            }
        }
        
        field.classList.add('is-valid');
        return true;
    }
    
    function validateForm() {
        let isValid = true;
        inputs.forEach(input => {
            if (!validateField(input)) {
                isValid = false;
            }
        });
        return isValid;
    }
    
    function updateProgress() {
        let completedSteps = 0;
        let totalSteps = inputs.length;
        
        inputs.forEach(input => {
            if (input.classList.contains('is-valid')) {
                completedSteps++;
            }
        });
        
        // Update progress bar
        const progressPercentage = (completedSteps / totalSteps) * 100;
        progressFill.style.width = progressPercentage + '%';
        
        // Update step indicators
        progressSteps.forEach((step, index) => {
            step.classList.remove('active', 'completed');
            
            if (index < completedSteps) {
                step.classList.add('completed');
            } else if (index === completedSteps) {
                step.classList.add('active');
            }
        });
    }
    
    // Enhanced accessibility
    inputs.forEach(input => {
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.target.type !== 'textarea') {
                e.preventDefault();
                const nextInput = inputs[Array.from(inputs).indexOf(this) + 1];
                if (nextInput) {
                    nextInput.focus();
                } else {
                    submitBtn.click();
                }
            }
        });
    });
    
    // Auto-focus first input
    inputs[0].focus();
    
    // Language translations
    const registerTranslations = {
        'en': { 
            'page_register': 'Register', 
            'register_title': 'Create an Account', 
            'register_for_contest': 'for contest', 
            'username_label': 'Username', 
            'email_label': 'Email Address', 
            'username_placeholder': 'e.g. johndoe', 
            'email_placeholder': 'e.g. john.doe@example.com',
            'have_account': 'Already have an account?', 
            'sign_in': 'Sign In' 
        },
        'hy': { 
            'page_register': 'Գրանցում', 
            'register_title': 'Ստեղծել Հաշիվ', 
            'register_for_contest': 'մրցույթի համար', 
            'username_label': 'Օգտանուն', 
            'email_label': 'Էլ․ հասցե', 
            'username_placeholder': 'օր.՝ poghosyan', 
            'email_placeholder': 'օր.՝ poghos@example.com',
            'have_account': 'Արդեն ունե՞ք հաշիվ', 
            'sign_in': 'Մուտք' 
        },
        'ru': { 
            'page_register': 'Регистрация', 
            'register_title': 'Создать Аккаунт', 
            'register_for_contest': 'для конкурса', 
            'username_label': 'Имя пользователя', 
            'email_label': 'Адрес электронной почты', 
            'username_placeholder': 'напр. ivanov', 
            'email_placeholder': 'напр. ivan.ivanov@example.com',
            'have_account': 'Уже есть аккаунт?', 
            'sign_in': 'Войти' 
        }
    };
    
    Object.keys(registerTranslations).forEach(lang => { 
        Object.assign(window.translations[lang], registerTranslations[lang]); 
    });
    
    const updatePageText = () => {
        const lang = localStorage.getItem('language') || 'en'; 
        const langDict = window.translations[lang] || window.translations['en'];
        
        document.querySelectorAll('[data-translate-key]').forEach(el => {
            const key = el.dataset.translateKey;
            if(el.type === 'submit') { 
                if(langDict.register_button_text) el.value = langDict.register_button_text; 
            } else if (langDict[key]) { 
                el.textContent = langDict[key]; 
            }
        });
        
        const userInput = document.querySelector('input[name="username"]'), 
              emailInput = document.querySelector('input[name="email"]');
        
        if(userInput) userInput.placeholder = langDict.username_placeholder || '';
        if(emailInput) emailInput.placeholder = langDict.email_placeholder || '';
    };
    
    updatePageText(); 
    window.addEventListener('languageChanged', updatePageText);
    
    // Initialize progress
    updateProgress();
});
</script>
{% endblock %}