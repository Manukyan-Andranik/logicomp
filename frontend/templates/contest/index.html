{% extends "base.html" %}

{% block title %}<span data-translate-key="title_contests">Contests</span>{% endblock %}

{% block extra_css %}
<style>
    main { background-color: #121212; }
    .nav-tabs .nav-link {
        border: none;
        border-bottom: 3px solid transparent;
        color: var(--text-muted);
        font-weight: 500;
        padding: 0.75rem 1.25rem;
    }
    .nav-tabs .nav-link.active,
    .nav-tabs .nav-link:hover {
        color: var(--primary);
        background-color: transparent;
        border-bottom-color: var(--primary);
    }
    
    .contest-card {
        background: #1a1a1a;
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        transition: all 0.3s ease;
    }
    .contest-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        border-color: var(--primary);
    }
    .contest-card .card-header,
    .contest-card .card-body,
    .contest-card .card-footer {
        background-color: transparent !important;
        border-color: var(--border-color) !important;
    }
    .contest-card .card-header { background-color: #212121 !important; }
    .contest-card .card-title { color: var(--primary); }

    .list-group-item {
        background-color: #1a1a1a !important;
        border-color: var(--border-color) !important;
        color: var(--text-light) !important;
        margin-bottom: 1rem;
        border-radius: 0.5rem !important;
    }
    .list-group-item:hover { background-color: #212121 !important; }
    
    .empty-state-card {
        background-color: #1a1a1a;
        border: 1px dashed var(--border-color);
        border-radius: 0.75rem;
    }
    .empty-state-card i {
        font-size: 3rem;
        color: var(--text-muted);
    }
</style>
{% endblock %}


{% block content %}
<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="text-white fw-bold d-flex align-items-center"><i class="bi bi-trophy-fill text-warning me-3"></i><span data-translate-key="header_contests">Contests</span></h1>
    </div>

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-4" id="contestTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="active-tab" data-bs-toggle="tab" data-bs-target="#active-contests-panel" type="button" role="tab"><span data-translate-key="tab_active">Active</span></button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="upcoming-tab" data-bs-toggle="tab" data-bs-target="#upcoming-contests-panel" type="button" role="tab"><span data-translate-key="tab_upcoming">Upcoming</span></button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="past-tab" data-bs-toggle="tab" data-bs-target="#past-contests-panel" type="button" role="tab"><span data-translate-key="tab_past">Past</span></button>
        </li>
    </ul>

    <!-- Tabs Content -->
    <div class="tab-content" id="contestTabsContent">
        <!-- Active Contests Panel -->
        <div class="tab-pane fade show active" id="active-contests-panel" role="tabpanel">
            <div class="row">
                {% if active_contests %}
                    {% for contest in active_contests %}
                    <div class="col-lg-6 mb-4">
                        <div class="card contest-card h-100 d-flex flex-column">
                            <div class="card-header"><h4 class="card-title mb-0">{{ contest.title }}</h4></div>
                            <div class="card-body flex-grow-1">
                                <p class="text-white-50" style="color: white !important;">{{ contest.description|truncate(120) }}</p>
                                <div class="d-flex justify-content-start align-items-center text-white-50 small mt-3">
                                    <span class="me-3">
                                        <i class="bi bi-code-slash me-1" style="color: white !important;"></i>
                                        <strong class="text-white">{{ contest.problems.count() }}</strong>
                                        <span data-translate-key="text_problems" style="color: white !important;">Problems</span>
                                    </span>
                                </div>
                            </div>
                            <div class="card-footer d-flex justify-content-between align-items-center">
                                <span class="badge fs-6" id="timer-{{ contest.id }}"></span>
                                <div>
                                {% if current_user.is_authenticated %}
                                    <a href="{{ url_for('contest.contest_view', contest_id=contest.id) }}" class="btn btn-sm btn-warning"><span data-translate-key="btn_enter">Enter</span> <i class="bi bi-arrow-right-short"></i></a>
                                {% else %}
                                    <a href="{{ url_for('contest.contest_view', contest_id=contest.id) }}" class="btn btn-sm btn-outline-secondary"><span data-translate-key="btn_details">Details</span></a>
                                    <a href="{{ url_for('auth.register') }}?contest_id={{ contest.id }}" class="btn btn-sm btn-warning"><span data-translate-key="btn_register">Register</span></a>
                                {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="col-12">
                        <div class="text-center p-5 empty-state-card">
                            <i class="bi bi-clock-history mb-3"></i>
                            <h5 class="text-white" data-translate-key="text_no_active_title">No Active Contests</h5>
                            <p class="text-muted" data-translate-key="text_no_active_desc">Please check the "Upcoming" tab for future events.</p>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Upcoming Contests Panel -->
        <div class="tab-pane fade" id="upcoming-contests-panel" role="tabpanel">
             <div class="list-group list-group-flush">
                {% if upcoming_contests %}
                    {% for contest in upcoming_contests %}
                    <div class="list-group-item d-flex flex-column flex-md-row justify-content-between align-items-md-center">
                        <div>
                            <h5 class="mb-1 text-warning">{{ contest.title }}</h5>
                            <p class="mb-1 text-muted">{{ contest.description|truncate(100) }}</p>
                        </div>
                        <div class="text-md-end mt-2 mt-md-0">
                            <span class="badge bg-primary fs-6" id="countdown-{{ contest.id }}"></span>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center p-5 empty-state-card">
                        <i class="bi bi-calendar-event mb-3"></i>
                        <h5 class="text-white" data-translate-key="text_no_upcoming_title">No Upcoming Contests</h5>
                        <p class="text-muted" data-translate-key="text_no_upcoming_desc">Stay tuned for future announcements.</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Past Contests Panel -->
        <div class="tab-pane fade" id="past-contests-panel" role="tabpanel">
            <div class="list-group list-group-flush">
                 {% if past_contests %}
                    {% for contest in past_contests %}
                    <a href="{{ url_for('contest.contest_view', contest_id=contest.id) }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0 text-warning">{{ contest.title }}</h5>
                        </div>
                        <span class="badge bg-secondary"><i class="bi bi-check2-circle me-1"></i><span data-translate-key="status_ended">Ended</span></span>
                    </a>
                    {% endfor %}
                {% else %}
                    <div class="text-center p-5 empty-state-card">
                         <i class="bi bi-archive mb-3"></i>
                         <h5 class="text-white" data-translate-key="text_no_past_title">No Past Contests</h5>
                         <p class="text-muted" data-translate-key="text_no_past_desc">Completed contests will appear here.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const pageTranslations = {
        en: { "title_contests": "Contests", "header_contests": "Contests", "tab_active": "Active", "tab_upcoming": "Upcoming", "tab_past": "Past", "btn_enter": "Enter", "btn_details": "Details", "btn_register": "Register", "text_problems": "Problems", "text_no_active_title": "No Active Contests", "text_no_active_desc": "Please check the 'Upcoming' tab for future events.", "text_no_upcoming_title": "No Upcoming Contests", "text_no_upcoming_desc": "Stay tuned for future announcements.", "text_no_past_title": "No Past Contests", "text_no_past_desc": "Completed contests will appear here.", "status_ended": "Ended", "status_started": "Started", "timer_ends_in": "Ends in", "timer_starts_in": "Starts in", "timer_d": "d", "timer_h": "h", "timer_m": "m", "timer_s": "s" },
        hy: { "title_contests": "Մրցույթներ", "header_contests": "Մրցույթներ", "tab_active": "Ակտիվ", "tab_upcoming": "Սպասվող", "tab_past": "Անցած", "btn_enter": "Մուտք", "btn_details": "Մանրամասներ", "btn_register": "Գրանցվել", "text_problems": "խնդիր", "text_no_active_title": "Ակտիվ մրցույթներ չկան", "text_no_active_desc": "Խնդրում ենք ստուգել «Սպասվող» բաժինը։", "text_no_upcoming_title": "Սպասվող մրցույթներ չկան", "text_no_upcoming_desc": "Հետևեք հետագա հայտարարություններին։", "text_no_past_title": "Անցած մրցույթներ չկան", "text_no_past_desc": "Ավարտված մրցույթները կհայտնվեն այստեղ։", "status_ended": "Ավարտված", "status_started": "Սկսված", "timer_ends_in": "Ավարտին՝", "timer_starts_in": "Մեկնարկին՝", "timer_d": "օ", "timer_h": "ժ", "timer_m": "ր", "timer_s": "վ" },
        ru: { "title_contests": "Конкурсы", "header_contests": "Конкурсы", "tab_active": "Активные", "tab_upcoming": "Ожидаются", "tab_past": "Прошедшие", "btn_enter": "Войти", "btn_details": "Детали", "btn_register": "Регистрация", "text_problems": "задач", "text_no_active_title": "Нет активных конкурсов", "text_no_active_desc": "Проверьте вкладку «Ожидаются» для будущих событий.", "text_no_upcoming_title": "Нет предстоящих конкурсов", "text_no_upcoming_desc": "Следите за будущими объявлениями.", "text_no_past_title": "Нет прошедших конкурсов", "text_no_past_desc": "Завершенные конкурсы появятся здесь.", "status_ended": "Завершён", "status_started": "Начался", "timer_ends_in": "До конца:", "timer_starts_in": "До старта:", "timer_d": "д", "timer_h": "ч", "timer_m": "м", "timer_s": "с" }
    };
    Object.keys(pageTranslations).forEach(lang => { if(window.translations && window.translations[lang]) Object.assign(window.translations[lang], pageTranslations[lang]); });
    
    const setupTimer = (elementId, isoTime, type) => {
        const timerEl = document.getElementById(elementId);
        if(!timerEl) return;
        if (window.timerIntervals && window.timerIntervals[elementId]) clearInterval(window.timerIntervals[elementId]);
        const targetTime = new Date(isoTime).getTime();
        const update = () => {
            const lang = localStorage.getItem('language') || 'en'; const dict = window.translations[lang]; const remaining = targetTime - new Date().getTime();
            if (remaining <= 0) {
                if (type === 'active') { timerEl.textContent = dict.status_ended; timerEl.className = 'badge bg-secondary fs-6'; } 
                else { timerEl.textContent = dict.status_started; timerEl.className = 'badge bg-success fs-6'; }
                if (window.timerIntervals && window.timerIntervals[elementId]) clearInterval(window.timerIntervals[elementId]);
                return;
            }
            const d = Math.floor(remaining / 86400000), h = Math.floor((remaining % 86400000) / 3600000), m = Math.floor((remaining % 3600000) / 60000), s = Math.floor((remaining % 60000) / 1000);
            let text = d > 0 ? `${d}${dict.timer_d} ${h}${dict.timer_h}` : h > 0 ? `${h}${dict.timer_h} ${m}${dict.timer_m}` : m > 0 ? `${m}${dict.timer_m} ${s}${dict.timer_s}` : `${s}${dict.timer_s}`;
            const prefix = type === 'active' ? dict.timer_ends_in : dict.timer_starts_in;
            timerEl.textContent = `${prefix} ${text}`;
            timerEl.className = type === 'active' ? 'badge bg-success fs-6' : 'badge bg-primary fs-6';
        };
        if (!window.timerIntervals) window.timerIntervals = {};
        window.timerIntervals[elementId] = setInterval(update, 1000);
        update();
    };

    const updatePageText = () => {
        const lang = localStorage.getItem('language') || 'en';
        const langDict = window.translations[lang] || window.translations['en'];
        document.querySelectorAll('[data-translate-key]').forEach(el => {
            const key = el.dataset.translateKey;
            if (langDict[key]) {
                el.textContent = langDict[key];
            }
        });
    };

    const initializePage = () => {
        updatePageText();
        "{% for contest in active_contests %}"
        setupTimer('timer-{{ contest.id }}', "{{ contest.end_time.isoformat() }}Z", 'active');
        "{% endfor %}"

        "{% for contest in upcoming_contests %}"
        setupTimer('countdown-{{ contest.id }}', "{{ contest.start_time.isoformat() }}Z", 'upcoming');
        "{% endfor %}"
    };

    initializePage();
    window.addEventListener('languageChanged', initializePage);
});
</script>
{% endblock %}